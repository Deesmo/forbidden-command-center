var _sj=(typeof safeJSON!=="undefined")?safeJSON:function(r){return r.json();};var toast=window['show'+'Toast']||function(){}; var BRAND_PREFIX = "A premium bourbon whiskey in a distinctive heavy glass 8-pointed star-shaped geometric decanter bottle. The bottle has sharp angular facets, fluted ridges, and a dark metallic label that reads 'FORBIDDEN' in elegant gold art deco lettering. The bourbon inside is dark amber/copper colored. The bottle has a heavy square stopper top. "; var BRAND_DETAIL = "The Forbidden Bourbon bottle is an art-deco geometric decanter with 8 pointed star cross-section, rigid angular lines cut into thick heavy glass, showing the dark amber bourbon inside. The label is dark with gold metallic 'FORBIDDEN' text in art deco font. "; // Fallback prompts (used if API call fails) var IMAGE_PROMPTS_FALLBACK = { product: [ "Dark marble surface, dramatic side lighting, smoky atmosphere", "Polished oak bar top, warm amber spotlights, blurred bar background", "Black slate surface with scattered ice crystals, rim lighting", "Aged leather desk, brass lamp, old books, warm library glow", "Raw wooden barrel top, dark moody warehouse background", "Clean white marble pedestal, studio lighting, luxury feel", ], lifestyle: [ "Cozy fireside setting, warm orange glow, leather armchair visible", "Outdoor porch at golden hour sunset, Kentucky rolling hills", "Upscale restaurant table, candlelight, bokeh city lights behind", "Rustic cabin interior, stone fireplace, wool blanket draped nearby", "Gentleman's study with globe, dark wood shelving, warm lamplight", "Summer evening patio, string lights, warm breeze atmosphere", ], artdeco: [ "Art deco geometric gold and black background, 1920s pattern", "Speakeasy interior, velvet curtains, brass fixtures, moody lighting", "Gold leaf textured wall, dramatic spotlight from above", "Gatsby-era black marble with gold geometric inlays", "Ornate gold frame on dark wall, gallery spotlight", "Black lacquer surface with gold flake accents, luxury aesthetic", ], cocktail: [ "Bar setup with Old Fashioned ingredients: orange peel, cherry, bitters", "Cocktail prep station: muddler, jigger, ice sphere, crystal glass", "Mint Julep scene: crushed ice, silver cup, fresh mint sprigs", "Whiskey Sour setup: lemon, egg white, cherry, shaker", "Summer bar scene: ice bucket, citrus slices, copper tools", "Cheese and charcuterie board, walnut cutting board, warm lighting", ], social: [ "Instagram-worthy flat lay: leather, watch, cigar, glasses", "Gift box scene: velvet lined box, ribbon, holiday setting", "Poolside luxury: marble edge, blue water, tropical plants", "Weekend brunch table, newspaper, coffee, warm morning light", "Party scene: confetti, gold accents, celebration mood", "Campfire glow, night sky, rustic outdoor setting", ], editorial: [ "Magazine-style dark gradient backdrop, professional studio lighting", "Kentucky bourbon country landscape, rolling hills, golden hour", "Barrel aging warehouse, rows of oak barrels, shaft of light", "Close-up textured background: charred oak, grain detail", "Copper still room, industrial distillery equipment, steam", "Wheat field at golden hour, Kentucky countryside", ] }; var VIDEO_PROMPTS_FALLBACK = { pour: [ "Slow-motion bourbon pour into crystal glass", "Close-up pour over a single ice sphere", "Bourbon stream catching golden light", "Pouring a perfect Old Fashioned", ], glamour: [ "Camera slowly orbiting the bottle", "Bottle reveal from shadow into spotlight", "Light rays moving across the bottle label", "Condensation drops on a chilled glass", ], bar: [ "Bartender crafting a cocktail, moody lighting", "Sliding bourbon glass down a polished bar", "Ice placed into glass, then bourbon poured", "Two glasses clinking in warm ambiance", ], nature: [ "Sunrise over Kentucky bourbon country", "Wheat swaying in warm breeze, golden hour", "Oak barrel in a field with morning fog", "Rain on barrel warehouse roof, cozy interior", ] }; // Templates loaded from API (populated on DOMContentLoaded) var _apiVideoTemplates = null; var _apiImageTemplates = null; var currentStyle = 'product'; var currentVideoStyle = 'pour'; var lastImagePrompt = ''; var lastVideoPrompt = ''; document.addEventListener('DOMContentLoaded', function() { loadApiTemplates().then(function() { loadPromptTemplates(); loadVideoPromptTemplates(); }).catch(function() { loadPromptTemplates(); loadVideoPromptTemplates(); }); checkApiKeys(); loadGallery(); var refCheckbox = document.getElementById('useBottleRef'); var compositeControls = document.getElementById('compositeControls'); if (refCheckbox && compositeControls) { refCheckbox.addEventListener('change', function() { compositeControls.style.display = this.checked ? 'flex' : 'none'; }); } }); if (document.readyState === 'complete' || document.readyState === 'interactive') { loadApiTemplates().then(function() { loadPromptTemplates(); loadVideoPromptTemplates(); }).catch(function() { loadPromptTemplates(); loadVideoPromptTemplates(); }); checkApiKeys(); loadGallery(); } function loadApiTemplates() { return fetch('/api/ai/templates').then(_sj).then(function(data) { if (data && data.video) { _apiVideoTemplates = data.video; } if (data && data.image) { _apiImageTemplates = data.image; } }).catch(function() { /* fall back to hardcoded */ }); } function checkApiKeys() { fetch('/api/ai/status').then(_sj).then(data => { const dalleEl = document.getElementById('dalleStatus'); const runwayEl = document.getElementById('runwayStatus'); const keysBtn = document.getElementById('keysBtn'); if (!dalleEl) return; dalleEl.innerHTML = data.openai ? '<span style="color: #4ade80;">‚óè DALL-E Ready</span>' : '<span style="color: #f87171;">‚óã DALL-E ‚Äî No Key</span>'; runwayEl.innerHTML = data.runway ? '<span style="color: #4ade80;">‚óè Runway Ready</span>' : '<span style="color: #f87171;">‚óã Runway ‚Äî No Key</span>'; if (!data.openai || !data.runway) { keysBtn.style.display = ''; } else { keysBtn.style.display = 'none'; document.getElementById('settingsPanel').classList.add('hidden'); } }).catch(function(err){ var d=document.getElementById('dalleStatus'); var r=document.getElementById('runwayStatus'); if(d){d.innerHTML='<span style="color:#f87171;">‚óã DALL-E ‚Äî Error</span>';} if(r){r.innerHTML='<span style="color:#f87171;">‚óã Runway ‚Äî Error</span>';} console.log('Status check error:',err); }); } function switchMode(mode, btn) { document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); document.getElementById('imageMode').classList.toggle('hidden', mode !== 'image'); document.getElementById('videoMode').classList.toggle('hidden', mode !== 'video'); document.getElementById('galleryMode').classList.toggle('hidden', mode !== 'gallery'); if (mode === 'gallery') loadGallery(); } function selectStyle(btn) { document.querySelectorAll('.style-preset[data-style]').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentStyle = btn.dataset.style; loadPromptTemplates(); } function selectVideoStyle(btn) { document.querySelectorAll('.style-preset[data-vstyle]').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentVideoStyle = btn.dataset.vstyle; loadVideoPromptTemplates(); } function loadPromptTemplates() { var c = document.getElementById('promptTemplates'); var prompts; if (_apiImageTemplates) { // Use API templates filtered by current style category prompts = _apiImageTemplates.filter(function(t) { return t.category === currentStyle || t.category === (currentStyle === 'artdeco' ? 'brand' : currentStyle); }).map(function(t) { return t.prompt; }); if (prompts.length === 0) { prompts = _apiImageTemplates.map(function(t) { return t.prompt; }).slice(0, 6); } } else { prompts = IMAGE_PROMPTS_FALLBACK[currentStyle] || []; } c.innerHTML = prompts.map(function(p) { return '<button class="prompt-chip" onclick="usePrompt(this,\'image\')">' + p + '</button>'; }).join(''); } function loadVideoPromptTemplates() { var c = document.getElementById('videoPromptTemplates'); var prompts; if (_apiVideoTemplates) { // Use API templates ‚Äî show all or filter by loose category mapping var catMap = { pour: 'product', glamour: 'product', bar: 'lifestyle', nature: 'heritage' }; var cat = catMap[currentVideoStyle] || 'product'; var filtered = _apiVideoTemplates.filter(function(t) { return t.category === cat; }); if (filtered.length === 0) filtered = _apiVideoTemplates.slice(0, 8); prompts = filtered.map(function(t) { return { label: t.label, prompt: t.prompt }; }); c.innerHTML = prompts.map(function(p) { return '<button class="prompt-chip" data-full-prompt="' + p.prompt.replace(/"/g, '&quot;') + '" onclick="useVideoTemplate(this)">' + p.label + '</button>'; }).join(''); return; } // Fallback prompts = (VIDEO_PROMPTS_FALLBACK[currentVideoStyle] || []).map(function(p) { return { label: p, prompt: p }; }); c.innerHTML = prompts.map(function(p) { return '<button class="prompt-chip" onclick="usePrompt(this,\'video\')">' + p.label + '</button>'; }).join(''); } function usePrompt(btn, type) { var ta = type === 'video' ? document.getElementById('videoPrompt') : document.getElementById('imagePrompt'); ta.value = btn.textContent; ta.focus(); } function useVideoTemplate(btn) { // API templates have full motion-focused prompts ‚Äî set directly document.getElementById('videoPrompt').value = btn.dataset.fullPrompt || btn.textContent; document.getElementById('videoPrompt').focus(); } // IMAGE GENERATION function generateImage() { var prompt = document.getElementById('imagePrompt').value.trim(); if (!prompt) { toast('Enter a prompt first', 'error'); return; } lastImagePrompt = prompt; var size = document.getElementById('imageSize').value; var quality = document.getElementById('imageQuality').value; var useRef = document.getElementById('useBottleRef').checked; var bottlePosition = document.getElementById('bottlePosition') ? document.getElementById('bottlePosition').value : 'center'; var bottleScale = document.getElementById('bottleScale') ? document.getElementById('bottleScale').value : '0.65'; var bottleType = document.getElementById('bottleType') ? document.getElementById('bottleType').value : 'small_batch'; document.getElementById('imageResult').classList.remove('hidden'); document.getElementById('imageLoading').classList.remove('hidden'); document.getElementById('imageOutput').classList.add('hidden'); document.getElementById('generateImageBtn').disabled = true; document.getElementById('generateImageBtn').textContent = useRef ? 'Building scene around bottle...' : 'Generating...'; var fullPrompt = prompt; if (!useRef) { fullPrompt = BRAND_DETAIL + prompt + ". Professional product photography, luxury spirits brand aesthetic."; } fetch('/api/ai/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: fullPrompt, size: size, quality: quality, use_reference: useRef, bottle_position: bottlePosition, bottle_scale: parseFloat(bottleScale), bottle_type: bottleType }) }).then(_sj).then(function(data) { document.getElementById('imageLoading').classList.add('hidden'); document.getElementById('generateImageBtn').disabled = false; document.getElementById('generateImageBtn').textContent = '‚ú¶ Generate Image'; if (data.error) { document.getElementById('imageError').classList.remove('hidden'); document.getElementById('imageErrorDetail').textContent = data.error; document.getElementById('imageOutput').classList.remove('hidden'); document.getElementById('generatedImage').style.display = 'none'; toast(data.error, 'error'); return; } if (!data.image_url) { document.getElementById('imageError').classList.remove('hidden'); document.getElementById('imageErrorDetail').textContent = 'No image URL in response'; document.getElementById('imageOutput').classList.remove('hidden'); document.getElementById('generatedImage').style.display = 'none'; toast('No image returned', 'error'); return; } document.getElementById('imageError').classList.add('hidden'); document.getElementById('generatedImage').style.display = ''; document.getElementById('generatedImage').src = data.image_url; document.getElementById('imageOutput').classList.remove('hidden'); window._currentGalleryId = data.gallery_id || null; window._currentImageSaved = false; document.getElementById('favBtn').textContent = '‚≠ê Favorite'; document.getElementById('favBtn').style.background = ''; var modelMsg = data.model ? ' (' + data.model + ')' : ''; toast('Image generated!' + modelMsg, 'success'); }).catch(function(err) { document.getElementById('imageLoading').classList.add('hidden'); document.getElementById('generateImageBtn').disabled = false; document.getElementById('generateImageBtn').textContent = '‚ú¶ Generate Image'; document.getElementById('imageError').classList.remove('hidden'); document.getElementById('imageErrorDetail').textContent = err.message; document.getElementById('imageOutput').classList.remove('hidden'); document.getElementById('generatedImage').style.display = 'none'; toast('Failed: ' + err.message, 'error'); }); } function regenerateImage() { document.getElementById('imagePrompt').value = lastImagePrompt; generateImage(); } function downloadImage() { var a = document.createElement('a'); a.href = document.getElementById('generatedImage').src; a.download = 'forbidden-ai-' + Date.now() + '.png'; a.click(); } function copyImageUrl() { navigator.clipboard.writeText(document.getElementById('generatedImage').src).then(function() { toast('URL copied!', 'success'); }); } // VIDEO GENERATION function generateVideo() { var prompt = document.getElementById('videoPrompt').value.trim(); if (!prompt) { toast('Enter a prompt first', 'error'); return; } lastVideoPrompt = prompt; var duration = document.getElementById('videoDuration').value; var sourceSelect = document.getElementById('videoSourceImage'); var sourceImage = sourceSelect ? sourceSelect.value : ''; document.getElementById('videoResult').classList.remove('hidden'); document.getElementById('videoLoading').classList.remove('hidden'); document.getElementById('videoOutput').classList.add('hidden'); document.getElementById('generateVideoBtn').disabled = true; document.getElementById('generateVideoBtn').textContent = 'Generating...'; document.getElementById('videoStatus').textContent = 'Submitting...'; // FIX: When source image provided, Runway already sees the bottle in the frame. // Per Runway Gen-4 docs: "reiterating elements that exist within the image in high // detail can lead to reduced motion or unexpected results." // Only add brand context when NO source image is provided (text-only mode). var fullPrompt; if (sourceImage) { // Motion/camera focused ‚Äî let the image speak for itself fullPrompt = prompt + '. Cinematic, warm golden and dark tones, luxury spirits commercial.'; } else { // Text-only: need brand context since there's no image fullPrompt = 'Forbidden Bourbon premium whiskey bottle, ' + prompt + '. Cinematic, luxury brand aesthetic, warm golden and dark tones.'; } var payload = { prompt: fullPrompt, duration: parseInt(duration) }; if (sourceImage) { payload.source_image = window.location.origin + sourceImage; } fetch('/api/ai/generate-video', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(_sj).then(function(data) { if (data.error) { document.getElementById('videoLoading').classList.add('hidden'); document.getElementById('generateVideoBtn').disabled = false; document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video'; toast(data.error, 'error'); document.getElementById('videoResult').classList.add('hidden'); return; } if (data.task_id) { pollVideoStatus(data.task_id); } else if (data.video_url) { showVideoResult(data.video_url); } }).catch(function(err) { document.getElementById('videoLoading').classList.add('hidden'); document.getElementById('generateVideoBtn').disabled = false; document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video'; toast('Failed: ' + err.message, 'error'); }); } function pollVideoStatus(taskId) { document.getElementById('videoStatus').textContent = 'Processing video...'; var interval = setInterval(function() { fetch('/api/ai/video-status/' + taskId).then(_sj).then(function(data) { if (data.status === 'SUCCEEDED' && data.video_url) { clearInterval(interval); showVideoResult(data.video_url); } else if (data.status === 'FAILED') { clearInterval(interval); document.getElementById('videoLoading').classList.add('hidden'); document.getElementById('generateVideoBtn').disabled = false; document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video'; toast('Video generation failed', 'error'); } else { document.getElementById('videoStatus').textContent = 'Status: ' + (data.status || 'processing') + '...'; } }); }, 5000); setTimeout(function() { clearInterval(interval); }, 300000); } function showVideoResult(url) { document.getElementById('videoLoading').classList.add('hidden'); document.getElementById('generateVideoBtn').disabled = false; document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video'; var video = document.getElementById('generatedVideo'); video.src = url; video.load(); document.getElementById('videoOutput').classList.remove('hidden'); toast('Video generated!', 'success'); } function regenerateVideo() { document.getElementById('videoPrompt').value = lastVideoPrompt; generateVideo(); } function downloadVideo() { var a = document.createElement('a'); a.href = document.getElementById('generatedVideo').src; a.download = 'forbidden-ai-' + Date.now() + '.mp4'; a.click(); } // FAVORITES function toggleFavorite() { var id = window._currentGalleryId; if (!id) { toast('Generate an image first', 'error'); return; } var newSaved = !window._currentImageSaved; fetch('/api/ai/save-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, saved: newSaved }) }).then(_sj).then(function(data) { if (data.success) { window._currentImageSaved = newSaved; document.getElementById('favBtn').textContent = newSaved ? '‚≠ê Favorited!' : '‚≠ê Favorite'; document.getElementById('favBtn').style.background = newSaved ? 'linear-gradient(135deg, rgba(200,164,94,0.3), var(--bg-card))' : ''; toast(newSaved ? 'Added to favorites!' : 'Removed from favorites', 'success'); } }); } // GALLERY var _galleryFilter = 'all'; function loadGallery(filter) { filter = filter || _galleryFilter; _galleryFilter = filter; document.getElementById('galAllBtn').className = filter === 'all' ? 'btn btn-primary btn-sm' : 'btn btn-sm'; document.getElementById('galSavedBtn').className = filter === 'saved' ? 'btn btn-primary btn-sm' : 'btn btn-sm'; var url = '/api/ai/gallery' + (filter === 'saved' ? '?saved=true' : ''); fetch(url).then(_sj).then(function(data) { var grid = document.getElementById('galleryGrid'); if (!data.items || data.items.length === 0) { var msg = filter === 'saved' ? '<p style="font-size:0.96rem;">No favorites yet</p><p style="font-size:0.94rem;margin-top:4px;">‚≠ê Favorite your best images to save them here</p>' : '<p style="font-size:0.96rem;">No generated content yet</p><p style="font-size:0.94rem;margin-top:4px;">Generate images or videos to build your library</p>'; grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted);">'+msg+'</div>'; return; } grid.innerHTML = data.items.map(function(item) { var shortPrompt = (item.prompt || '').substring(0, 30) + (item.prompt && item.prompt.length > 30 ? '...' : ''); var savedStar = item.saved ? '<span style="position:absolute;top:6px;right:6px;font-size:1.1rem;text-shadow:0 1px 3px rgba(0,0,0,0.8);">‚≠ê</span>' : ''; var bottleTag = item.bottle_type ? '<span style="position:absolute;top:6px;left:6px;font-size:0.7rem;background:rgba(0,0,0,0.6);color:var(--gold);padding:2px 6px;border-radius:4px;">'+(item.bottle_type === 'single_barrel' ? 'SGL' : 'SB')+'</span>' : ''; if (item.type === 'video') { // Check if URL is a local /api/video/ path (reliable) or expired CDN URL var isLocal = item.url && (item.url.startsWith('/api/video/') || item.url.startsWith('/static/uploads/')); // Normalize old /static/uploads/ URLs to /api/video/ var playUrl = item.url; if (item.url && item.url.startsWith('/static/uploads/video_final_')) { playUrl = item.url.replace('/static/uploads/', '/api/video/'); } var expiredBadge = !isLocal ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;font-size:0.75rem;color:#f87171;">‚ö† Expired CDN</div>' : ''; return '<div style="position:relative;border-radius:var(--radius-md);overflow:hidden;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;" onclick="openVideoLightbox(\''+playUrl+'\')"><video src="'+(isLocal ? playUrl : '')+'" style="width:100%;height:180px;object-fit:cover;" muted preload="metadata"></video>'+expiredBadge+savedStar+'<div style="padding:6px 8px;font-size:0.8rem;color:var(--text-muted);">üé¨ '+shortPrompt+'</div></div>'; } var saveBtn = item.id ? '<button onclick="event.stopPropagation();galToggleSave('+item.id+','+(!item.saved)+',this)" style="position:absolute;bottom:32px;right:6px;background:rgba(0,0,0,0.6);border:none;color:white;font-size:0.9rem;padding:3px 6px;border-radius:4px;cursor:pointer;">'+(item.saved ? '‚≠ê' : '‚òÜ')+'</button>' : ''; return '<div style="position:relative;border-radius:var(--radius-md);overflow:hidden;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;" onclick="window.open(\''+item.url+'\')"><img src="'+item.url+'" loading="lazy" style="width:100%;height:180px;object-fit:cover;">'+savedStar+bottleTag+saveBtn+'<div style="padding:6px 8px;font-size:0.8rem;color:var(--text-muted);">üé® '+shortPrompt+'</div></div>'; }).join(''); }); } function openVideoLightbox(url) { if (!url) { toast('Video URL expired ‚Äî regenerate this video', 'error'); return; } var lb = document.getElementById('videoLightbox'); var vid = document.getElementById('lightboxVideo'); vid.src = url; vid.load(); lb.style.display = 'flex'; document.body.style.overflow = 'hidden'; } function closeVideoLightbox(e) { if (e && e.target !== document.getElementById('videoLightbox') && !e.target.closest('button[onclick="closeVideoLightbox()"]')) return; var vid = document.getElementById('lightboxVideo'); vid.pause(); vid.src = ''; document.getElementById('videoLightbox').style.display = 'none'; document.body.style.overflow = ''; } function galToggleSave(id, saved, btn) { fetch('/api/ai/save-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id, saved: saved }) }).then(_sj).then(function(data) { if (data.success) { toast(saved ? 'Added to favorites!' : 'Removed from favorites', 'success'); loadGallery(); } }); } // API KEYS function saveKey(provider) { var key = provider === 'openai' ? document.getElementById('openaiKey').value.trim() : document.getElementById('runwayKey').value.trim(); if (!key) { toast('Enter a key first', 'error'); return; } fetch('/api/ai/save-key', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ provider: provider, key: key }) }).then(_sj).then(function(data) { if (data.success) { toast(provider + ' key saved!', 'success'); checkApiKeys(); document.getElementById(provider === 'openai' ? 'openaiKey' : 'runwayKey').value = ''; } else { toast(data.error || 'Failed', 'error'); } }); }