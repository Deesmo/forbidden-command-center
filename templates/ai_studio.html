{% extends "base.html" %}
{% block title %}AI Studio{% endblock %}

{% block content %}
<div class="page-header">
    <h1>AI Studio</h1>
    <p class="subtitle">Generate brand images & videos for Forbidden Bourbon</p>
</div>

<!-- API KEY STATUS -->
<div id="apiStatus" class="card" style="margin-bottom: 16px; padding: 12px 16px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 12px; align-items: center; font-size: 1rem;">
            <span id="dalleStatus">‚è≥ Checking...</span>
            <span id="runwayStatus">‚è≥ Checking...</span>
        </div>
        <button id="keysBtn" class="btn btn-sm" onclick="document.getElementById('settingsPanel').classList.toggle('hidden')" style="font-size: 1.02rem; display: none;">‚öô Keys</button>
    </div>
    <div id="settingsPanel" class="hidden" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
        <div class="form-group" style="margin-bottom: 8px;">
            <label style="font-size: 1.05rem;">OpenAI API Key</label>
            <div style="display: flex; gap: 8px;">
                <input type="password" id="openaiKey" class="form-control" placeholder="sk-..." style="font-size: 1rem;">
                <button class="btn btn-primary btn-sm" onclick="saveKey('openai')">Save</button>
            </div>
        </div>
        <div class="form-group" style="margin-bottom: 4px;">
            <label style="font-size: 1.05rem;">Runway ML API Key</label>
            <div style="display: flex; gap: 8px;">
                <input type="password" id="runwayKey" class="form-control" placeholder="key_..." style="font-size: 1rem;">
                <button class="btn btn-primary btn-sm" onclick="saveKey('runway')">Save</button>
            </div>
        </div>
        <p style="font-size: 1.05rem; color: var(--text-muted); margin-top: 8px;">Or set OPENAI_API_KEY / RUNWAY_API_KEY in Render env vars (recommended).</p>
    </div>
</div>

<!-- MODE TABS -->
<div class="filter-tabs" style="margin-bottom: 16px;">
    <button class="filter-tab active" onclick="switchMode('image', this)">üé® Images</button>
    <button class="filter-tab" onclick="switchMode('video', this)">üé¨ Video</button>
    <button class="filter-tab" onclick="switchMode('gallery', this)">üìÅ Gallery</button>
</div>

<!-- ==================== IMAGE MODE ==================== -->
<div id="imageMode">
    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Style Preset</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
            <button class="style-preset active" data-style="product" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">ü•É</span><span>Product</span>
            </button>
            <button class="style-preset" data-style="lifestyle" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">‚ú®</span><span>Lifestyle</span>
            </button>
            <button class="style-preset" data-style="artdeco" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">üèõ</span><span>Art Deco</span>
            </button>
            <button class="style-preset" data-style="cocktail" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">üç∏</span><span>Cocktail</span>
            </button>
            <button class="style-preset" data-style="social" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">üì±</span><span>Social Ad</span>
            </button>
            <button class="style-preset" data-style="editorial" onclick="selectStyle(this)">
                <span style="font-size: 1.2rem;">üì∞</span><span>Editorial</span>
            </button>
        </div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Quick Scenes</h3>
        <div id="promptTemplates" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Describe the Scene</h3>
        <textarea id="imagePrompt" class="form-control" rows="4" placeholder="Describe the background scene (your real bottle will be placed on it)..."></textarea>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <select id="imageSize" class="form-control" style="flex: 1;">
                <option value="1024x1024">Square 1:1</option>
                <option value="1792x1024">Landscape 16:9</option>
                <option value="1024x1792" selected>Portrait 9:16</option>
            </select>
            <select id="imageQuality" class="form-control" style="flex: 1;">
                <option value="medium">Standard</option>
                <option value="high" selected>High</option>
            </select>
        </div>
        <div style="margin-top: 10px; padding: 12px; background: rgba(200,164,94,0.08); border-radius: 6px; border: 1px solid var(--border);">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="useBottleRef" checked style="width: 18px; height: 18px; accent-color: var(--gold);">
                <span style="font-size: 0.95rem; color: var(--gold); font-weight: 600;">üì∏ Composite Mode ‚Äî Real Bottle (Recommended)</span>
            </label>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">AI generates ONLY the background scene, then your REAL bottle photo is composited on top. This guarantees your exact bottle ‚Äî correct label, proof, shape, everything.</p>
            
            <div id="compositeControls" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                <div style="flex: 1; min-width: 120px;">
                    <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Bottle</label>
                    <select id="bottleType" class="form-control" style="font-size: 0.9rem;">
                        <option value="small_batch" selected>Small Batch (Black Label)</option>
                        <option value="single_barrel">Single Barrel (Gold Label)</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 90px;">
                    <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Position</label>
                    <select id="bottlePosition" class="form-control" style="font-size: 0.9rem;">
                        <option value="center" selected>Center</option>
                        <option value="left">Left</option>
                        <option value="right">Right</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 90px;">
                    <label style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">Bottle Size</label>
                    <select id="bottleScale" class="form-control" style="font-size: 0.9rem;">
                        <option value="0.45">Small</option>
                        <option value="0.55">Medium</option>
                        <option value="0.65" selected>Large</option>
                        <option value="0.78">Extra Large</option>
                    </select>
                </div>
            </div>
        </div>
        <button id="generateImageBtn" class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="generateImage()">
            ‚ú¶ Generate Image
        </button>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; text-align: center;">
            Composite mode: AI builds the scene around your real bottle ‚Äî natural lighting, shadows, and reflections.
        </p>
    </div>

    <div id="imageResult" class="card hidden" style="margin-bottom: 16px;">
        <div id="imageLoading" class="hidden" style="text-align: center; padding: 40px;">
            <div class="ai-spinner"></div>
            <p style="margin-top: 12px; color: var(--text-secondary); font-size: 1.05rem;">Generating your image...</p>
            <p style="color: var(--text-muted); font-size: 1.02rem;">This takes 10-20 seconds</p>
        </div>
        <div id="imageOutput" class="hidden">
            <div id="imageError" class="hidden" style="text-align: center; padding: 20px; background: rgba(248,113,113,0.1); border-radius: var(--radius-md); margin-bottom: 8px;">
                <p style="color: #f87171; font-size: 1rem; margin-bottom: 4px;">‚ö† Image failed to load</p>
                <p id="imageErrorDetail" style="color: var(--text-muted); font-size: 0.85rem;"></p>
            </div>
            <img id="generatedImage" src="" alt="Generated" style="width: 100%; border-radius: var(--radius-md);" onerror="document.getElementById('imageError').classList.remove('hidden'); document.getElementById('imageErrorDetail').textContent='URL: '+this.src.substring(0,80)+'...'; this.style.display='none';" onload="document.getElementById('imageError').classList.add('hidden'); this.style.display='';">
            <div style="padding: 12px 0 0; display: flex; gap: 8px;">
                <button class="btn btn-primary btn-sm" onclick="downloadImage()" style="flex: 1;">‚¨á Save</button>
                <button id="favBtn" class="btn btn-sm" onclick="toggleFavorite()" style="flex: 1;">‚≠ê Favorite</button>
                <button class="btn btn-sm" onclick="copyImageUrl()" style="flex: 1;">üìã Copy URL</button>
                <button class="btn btn-sm" onclick="regenerateImage()" style="flex: 1;">üîÑ Redo</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== VIDEO MODE ==================== -->
<div id="videoMode" class="hidden">
    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Video Style</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <button class="style-preset active" data-vstyle="pour" onclick="selectVideoStyle(this)">
                <span style="font-size: 1.2rem;">ü•É</span><span>Bourbon Pour</span>
            </button>
            <button class="style-preset" data-vstyle="glamour" onclick="selectVideoStyle(this)">
                <span style="font-size: 1.2rem;">‚ú®</span><span>Bottle Glamour</span>
            </button>
            <button class="style-preset" data-vstyle="bar" onclick="selectVideoStyle(this)">
                <span style="font-size: 1.2rem;">üç∏</span><span>Bar Scene</span>
            </button>
            <button class="style-preset" data-vstyle="nature" onclick="selectVideoStyle(this)">
                <span style="font-size: 1.2rem;">üåø</span><span>Kentucky</span>
            </button>
        </div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Quick Prompts</h3>
        <div id="videoPromptTemplates" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <h3 style="margin-bottom: 12px; font-size: 1.05rem; color: var(--gold);">Video Prompt</h3>
        <textarea id="videoPrompt" class="form-control" rows="4" placeholder="Describe the video you want to generate..."></textarea>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <select id="videoDuration" class="form-control">
                <option value="5">5 seconds</option>
                <option value="10" selected>10 seconds</option>
            </select>
        </div>
        <div style="margin-top: 10px; padding: 10px; background: rgba(200,164,94,0.08); border-radius: 6px; border: 1px solid var(--border);">
            <label style="font-size: 0.95rem; color: var(--gold); display: block; margin-bottom: 6px;">üì∏ Source Image (uses real bottle photo as starting frame)</label>
            <select id="videoSourceImage" class="form-control" style="font-size: 0.95rem;">
                <option value="">Text-only (no source image)</option>
                <option value="/static/photos/bottle-top.jpg" selected>Forbidden Bottle ‚Äî Hero Shot</option>
                {% for photo in ['xmas-whiskey-sour-1.jpg','xmas-whiskey-sour-2.jpg','xmas-whiskey-sour-3.jpg','xmas-whiskey-sour-4.jpg','xmas-whiskey-sour-5.jpg'] %}
                <option value="/static/photos/{{ photo }}">{{ photo | replace('-',' ') | replace('.jpg','') | title }}</option>
                {% endfor %}
            </select>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Runway uses the source image as the first frame, then animates your prompt from there.</p>
        </div>
        <button id="generateVideoBtn" class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="generateVideo()">
            üé¨ Generate Video
        </button>
    </div>

    <div id="videoResult" class="card hidden" style="margin-bottom: 16px;">
        <div id="videoLoading" class="hidden" style="text-align: center; padding: 40px;">
            <div class="ai-spinner"></div>
            <p style="margin-top: 12px; color: var(--text-secondary); font-size: 1.05rem;">Generating video...</p>
            <p style="color: var(--text-muted); font-size: 1.02rem;">This can take 1-3 minutes</p>
            <p id="videoStatus" style="color: var(--gold-dark); font-size: 1.02rem; margin-top: 8px;"></p>
        </div>
        <div id="videoOutput" class="hidden">
            <video id="generatedVideo" controls playsinline style="width: 100%; border-radius: var(--radius-md);"></video>
            <div style="padding: 12px 0 0; display: flex; gap: 8px;">
                <button class="btn btn-primary btn-sm" onclick="downloadVideo()" style="flex: 1;">‚¨á Save</button>
                <button class="btn btn-sm" onclick="regenerateVideo()" style="flex: 1;">üîÑ Redo</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== GALLERY MODE ==================== -->
<div id="galleryMode" class="hidden">
    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="galAllBtn" class="btn btn-primary btn-sm" onclick="loadGallery('all')" style="flex:1;">üìÅ All Images</button>
        <button id="galSavedBtn" class="btn btn-sm" onclick="loadGallery('saved')" style="flex:1;">‚≠ê Favorites</button>
    </div>
    <div id="galleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px;">
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
            <p style="font-size: 1.05rem;">No generated content yet</p>
            <p style="font-size: 1.02rem; margin-top: 4px;">Generate images or videos to build your library</p>
        </div>
    </div>
</div>

<style>
    .style-preset {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        padding: 12px 8px; background: var(--bg-input); border: 1px solid var(--border);
        border-radius: var(--radius-md); color: var(--text-secondary);
        font-size: 1.02rem; cursor: pointer; transition: all 0.2s;
    }
    .style-preset:hover { border-color: var(--gold-dark); }
    .style-preset.active {
        border-color: var(--gold);
        background: linear-gradient(135deg, rgba(200,164,94,0.1), var(--bg-card));
        color: var(--gold);
    }
    .prompt-chip {
        padding: 6px 12px; background: var(--bg-input); border: 1px solid var(--border);
        border-radius: 20px; color: var(--text-secondary); font-size: 1.02rem;
        cursor: pointer; transition: all 0.2s;
    }
    .prompt-chip:hover { border-color: var(--gold-dark); color: var(--gold); }
    .ai-spinner {
        width: 40px; height: 40px; border: 3px solid var(--border);
        border-top: 3px solid var(--gold); border-radius: 50%;
        animation: aispin 1s linear infinite; margin: 0 auto;
    }
    @keyframes aispin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block scripts %}
<script>
    const BRAND_PREFIX = "A premium bourbon whiskey in a distinctive heavy glass 8-pointed star-shaped geometric decanter bottle. The bottle has sharp angular facets, fluted ridges, and a dark metallic label that reads 'FORBIDDEN' in elegant gold art deco lettering. The bourbon inside is dark amber/copper colored. The bottle has a heavy square stopper top. ";

    const BRAND_DETAIL = "The Forbidden Bourbon bottle is an art-deco geometric decanter with 8 pointed star cross-section, rigid angular lines cut into thick heavy glass, showing the dark amber bourbon inside. The label is dark with gold metallic 'FORBIDDEN' text in art deco font. ";

    const IMAGE_PROMPTS = {
        product: [
            "Dark marble surface, dramatic side lighting, smoky atmosphere",
            "Polished oak bar top, warm amber spotlights, blurred bar background",
            "Black slate surface with scattered ice crystals, rim lighting",
            "Aged leather desk, brass lamp, old books, warm library glow",
            "Raw wooden barrel top, dark moody warehouse background",
            "Clean white marble pedestal, studio lighting, luxury feel",
        ],
        lifestyle: [
            "Cozy fireside setting, warm orange glow, leather armchair visible",
            "Outdoor porch at golden hour sunset, Kentucky rolling hills",
            "Upscale restaurant table, candlelight, bokeh city lights behind",
            "Rustic cabin interior, stone fireplace, wool blanket draped nearby",
            "Gentleman's study with globe, dark wood shelving, warm lamplight",
            "Summer evening patio, string lights, warm breeze atmosphere",
        ],
        artdeco: [
            "Art deco geometric gold and black background, 1920s pattern",
            "Speakeasy interior, velvet curtains, brass fixtures, moody lighting",
            "Gold leaf textured wall, dramatic spotlight from above",
            "Gatsby-era black marble with gold geometric inlays",
            "Ornate gold frame on dark wall, gallery spotlight",
            "Black lacquer surface with gold flake accents, luxury aesthetic",
        ],
        cocktail: [
            "Bar setup with Old Fashioned ingredients: orange peel, cherry, bitters",
            "Cocktail prep station: muddler, jigger, ice sphere, crystal glass",
            "Mint Julep scene: crushed ice, silver cup, fresh mint sprigs",
            "Whiskey Sour setup: lemon, egg white, cherry, shaker",
            "Summer bar scene: ice bucket, citrus slices, copper tools",
            "Cheese and charcuterie board, walnut cutting board, warm lighting",
        ],
        social: [
            "Instagram-worthy flat lay: leather, watch, cigar, glasses",
            "Gift box scene: velvet lined box, ribbon, holiday setting",
            "Poolside luxury: marble edge, blue water, tropical plants",
            "Weekend brunch table, newspaper, coffee, warm morning light",
            "Party scene: confetti, gold accents, celebration mood",
            "Campfire glow, night sky, rustic outdoor setting",
        ],
        editorial: [
            "Magazine-style dark gradient backdrop, professional studio lighting",
            "Kentucky bourbon country landscape, rolling hills, golden hour",
            "Barrel aging warehouse, rows of oak barrels, shaft of light",
            "Close-up textured background: charred oak, grain detail",
            "Copper still room, industrial distillery equipment, steam",
            "Wheat field at golden hour, Kentucky countryside",
        ]
    };

    const VIDEO_PROMPTS = {
        pour: [
            "Slow-motion bourbon pour into crystal glass",
            "Close-up pour over a single ice sphere",
            "Bourbon stream catching golden light",
            "Pouring a perfect Old Fashioned",
        ],
        glamour: [
            "Camera slowly orbiting the bottle",
            "Bottle reveal from shadow into spotlight",
            "Light rays moving across the bottle label",
            "Condensation drops on a chilled glass",
        ],
        bar: [
            "Bartender crafting a cocktail, moody lighting",
            "Sliding bourbon glass down a polished bar",
            "Ice placed into glass, then bourbon poured",
            "Two glasses clinking in warm ambiance",
        ],
        nature: [
            "Sunrise over Kentucky bourbon country",
            "Wheat swaying in warm breeze, golden hour",
            "Oak barrel in a field with morning fog",
            "Rain on barrel warehouse roof, cozy interior",
        ]
    };

    let currentStyle = 'product';
    let currentVideoStyle = 'pour';
    let lastImagePrompt = '';
    let lastVideoPrompt = '';

    document.addEventListener('DOMContentLoaded', function() {
        loadPromptTemplates();
        loadVideoPromptTemplates();
        checkApiKeys();
        loadGallery();
        // Toggle composite controls visibility
        var refCheckbox = document.getElementById('useBottleRef');
        var compositeControls = document.getElementById('compositeControls');
        if (refCheckbox && compositeControls) {
            refCheckbox.addEventListener('change', function() {
                compositeControls.style.display = this.checked ? 'flex' : 'none';
            });
        }
    });
    
    // Also run on SPA navigation (DOMContentLoaded won't fire)
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        loadPromptTemplates();
        loadVideoPromptTemplates();
        checkApiKeys();
        loadGallery();
    }

    function checkApiKeys() {
        fetch('/api/ai/status').then(safeJSON).then(data => {
            const dalleEl = document.getElementById('dalleStatus');
            const runwayEl = document.getElementById('runwayStatus');
            const keysBtn = document.getElementById('keysBtn');
            if (!dalleEl) return; // Not on AI Studio page
            dalleEl.innerHTML = data.openai
                ? '<span style="color: #4ade80;">‚óè DALL-E Ready</span>'
                : '<span style="color: #f87171;">‚óã DALL-E ‚Äî No Key</span>';
            runwayEl.innerHTML = data.runway
                ? '<span style="color: #4ade80;">‚óè Runway Ready</span>'
                : '<span style="color: #f87171;">‚óã Runway ‚Äî No Key</span>';
            // Only show ‚öô Keys button if something is missing
            if (!data.openai || !data.runway) {
                keysBtn.style.display = '';
            } else {
                keysBtn.style.display = 'none';
                document.getElementById('settingsPanel').classList.add('hidden');
            }
        }).catch(err => console.log('Status check error:', err));
    }

    function switchMode(mode, btn) {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('imageMode').classList.toggle('hidden', mode !== 'image');
        document.getElementById('videoMode').classList.toggle('hidden', mode !== 'video');
        document.getElementById('galleryMode').classList.toggle('hidden', mode !== 'gallery');
        if (mode === 'gallery') loadGallery();
    }

    function selectStyle(btn) {
        document.querySelectorAll('.style-preset[data-style]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStyle = btn.dataset.style;
        loadPromptTemplates();
    }

    function selectVideoStyle(btn) {
        document.querySelectorAll('.style-preset[data-vstyle]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentVideoStyle = btn.dataset.vstyle;
        loadVideoPromptTemplates();
    }

    function loadPromptTemplates() {
        var c = document.getElementById('promptTemplates');
        c.innerHTML = (IMAGE_PROMPTS[currentStyle]||[]).map(function(p) {
            return '<button class="prompt-chip" onclick="usePrompt(this,\'image\')">' + p + '</button>';
        }).join('');
    }

    function loadVideoPromptTemplates() {
        var c = document.getElementById('videoPromptTemplates');
        c.innerHTML = (VIDEO_PROMPTS[currentVideoStyle]||[]).map(function(p) {
            return '<button class="prompt-chip" onclick="usePrompt(this,\'video\')">' + p + '</button>';
        }).join('');
    }

    function usePrompt(btn, type) {
        var ta = type === 'video' ? document.getElementById('videoPrompt') : document.getElementById('imagePrompt');
        ta.value = btn.textContent;
        ta.focus();
    }

    // IMAGE GENERATION
    function generateImage() {
        var prompt = document.getElementById('imagePrompt').value.trim();
        if (!prompt) { showToast('Enter a prompt first', 'error'); return; }
        lastImagePrompt = prompt;
        var size = document.getElementById('imageSize').value;
        var quality = document.getElementById('imageQuality').value;
        var useRef = document.getElementById('useBottleRef').checked;
        var bottlePosition = document.getElementById('bottlePosition') ? document.getElementById('bottlePosition').value : 'center';
        var bottleScale = document.getElementById('bottleScale') ? document.getElementById('bottleScale').value : '0.65';
        var bottleType = document.getElementById('bottleType') ? document.getElementById('bottleType').value : 'small_batch';
        
        document.getElementById('imageResult').classList.remove('hidden');
        document.getElementById('imageLoading').classList.remove('hidden');
        document.getElementById('imageOutput').classList.add('hidden');
        document.getElementById('generateImageBtn').disabled = true;
        document.getElementById('generateImageBtn').textContent = useRef ? 'Building scene around bottle...' : 'Generating...';

        // In composite mode, send the scene description as-is (backend handles everything)
        // In text-only mode, add brand context
        var fullPrompt = prompt;
        if (!useRef) {
            fullPrompt = BRAND_DETAIL + prompt + ". Professional product photography, luxury spirits brand aesthetic.";
        }

        fetch('/api/ai/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: fullPrompt, 
                size: size, 
                quality: quality, 
                use_reference: useRef,
                bottle_position: bottlePosition,
                bottle_scale: parseFloat(bottleScale),
                bottle_type: bottleType
            })
        }).then(safeJSON).then(function(data) {
            document.getElementById('imageLoading').classList.add('hidden');
            document.getElementById('generateImageBtn').disabled = false;
            document.getElementById('generateImageBtn').textContent = '‚ú¶ Generate Image';
            if (data.error) {
                document.getElementById('imageError').classList.remove('hidden');
                document.getElementById('imageErrorDetail').textContent = data.error;
                document.getElementById('imageOutput').classList.remove('hidden');
                document.getElementById('generatedImage').style.display = 'none';
                showToast(data.error, 'error');
                return;
            }
            if (!data.image_url) {
                document.getElementById('imageError').classList.remove('hidden');
                document.getElementById('imageErrorDetail').textContent = 'No image URL in response';
                document.getElementById('imageOutput').classList.remove('hidden');
                document.getElementById('generatedImage').style.display = 'none';
                showToast('No image returned', 'error');
                return;
            }
            document.getElementById('imageError').classList.add('hidden');
            document.getElementById('generatedImage').style.display = '';
            document.getElementById('generatedImage').src = data.image_url;
            document.getElementById('imageOutput').classList.remove('hidden');
            // Track gallery ID for favorites
            window._currentGalleryId = data.gallery_id || null;
            window._currentImageSaved = false;
            document.getElementById('favBtn').textContent = '‚≠ê Favorite';
            document.getElementById('favBtn').style.background = '';
            var modelMsg = data.model ? ' (' + data.model + ')' : '';
            showToast('Image generated!' + modelMsg, 'success');
        }).catch(function(err) {
            document.getElementById('imageLoading').classList.add('hidden');
            document.getElementById('generateImageBtn').disabled = false;
            document.getElementById('generateImageBtn').textContent = '‚ú¶ Generate Image';
            document.getElementById('imageError').classList.remove('hidden');
            document.getElementById('imageErrorDetail').textContent = err.message;
            document.getElementById('imageOutput').classList.remove('hidden');
            document.getElementById('generatedImage').style.display = 'none';
            showToast('Failed: ' + err.message, 'error');
        });
    }

    function regenerateImage() {
        document.getElementById('imagePrompt').value = lastImagePrompt;
        generateImage();
    }

    function downloadImage() {
        var a = document.createElement('a');
        a.href = document.getElementById('generatedImage').src;
        a.download = 'forbidden-ai-' + Date.now() + '.png';
        a.click();
    }

    function copyImageUrl() {
        navigator.clipboard.writeText(document.getElementById('generatedImage').src).then(function() {
            showToast('URL copied!', 'success');
        });
    }

    // VIDEO GENERATION
    function generateVideo() {
        var prompt = document.getElementById('videoPrompt').value.trim();
        if (!prompt) { showToast('Enter a prompt first', 'error'); return; }
        lastVideoPrompt = prompt;
        var duration = document.getElementById('videoDuration').value;
        var sourceSelect = document.getElementById('videoSourceImage');
        var sourceImage = sourceSelect ? sourceSelect.value : '';
        document.getElementById('videoResult').classList.remove('hidden');
        document.getElementById('videoLoading').classList.remove('hidden');
        document.getElementById('videoOutput').classList.add('hidden');
        document.getElementById('generateVideoBtn').disabled = true;
        document.getElementById('generateVideoBtn').textContent = 'Generating...';
        document.getElementById('videoStatus').textContent = 'Submitting...';

        var fullPrompt = "Forbidden Bourbon premium whiskey brand, " + prompt + ". Cinematic, luxury brand aesthetic, warm golden and dark tones.";

        var payload = { prompt: fullPrompt, duration: parseInt(duration) };
        if (sourceImage) {
            // Convert relative path to full URL for Runway
            payload.source_image = window.location.origin + sourceImage;
        }

        fetch('/api/ai/generate-video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(safeJSON).then(function(data) {
            if (data.error) {
                document.getElementById('videoLoading').classList.add('hidden');
                document.getElementById('generateVideoBtn').disabled = false;
                document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video';
                showToast(data.error, 'error');
                document.getElementById('videoResult').classList.add('hidden');
                return;
            }
            if (data.task_id) {
                pollVideoStatus(data.task_id);
            } else if (data.video_url) {
                showVideoResult(data.video_url);
            }
        }).catch(function(err) {
            document.getElementById('videoLoading').classList.add('hidden');
            document.getElementById('generateVideoBtn').disabled = false;
            document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video';
            showToast('Failed: ' + err.message, 'error');
        });
    }

    function pollVideoStatus(taskId) {
        document.getElementById('videoStatus').textContent = 'Processing video...';
        var interval = setInterval(function() {
            fetch('/api/ai/video-status/' + taskId).then(safeJSON).then(function(data) {
                if (data.status === 'SUCCEEDED' && data.video_url) {
                    clearInterval(interval);
                    showVideoResult(data.video_url);
                } else if (data.status === 'FAILED') {
                    clearInterval(interval);
                    document.getElementById('videoLoading').classList.add('hidden');
                    document.getElementById('generateVideoBtn').disabled = false;
                    document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video';
                    showToast('Video generation failed', 'error');
                } else {
                    document.getElementById('videoStatus').textContent = 'Status: ' + (data.status || 'processing') + '...';
                }
            });
        }, 5000);
        setTimeout(function() { clearInterval(interval); }, 300000);
    }

    function showVideoResult(url) {
        document.getElementById('videoLoading').classList.add('hidden');
        document.getElementById('generateVideoBtn').disabled = false;
        document.getElementById('generateVideoBtn').textContent = 'üé¨ Generate Video';
        var video = document.getElementById('generatedVideo');
        video.src = url;
        video.load();
        document.getElementById('videoOutput').classList.remove('hidden');
        showToast('Video generated!', 'success');
    }

    function regenerateVideo() {
        document.getElementById('videoPrompt').value = lastVideoPrompt;
        generateVideo();
    }

    function downloadVideo() {
        var a = document.createElement('a');
        a.href = document.getElementById('generatedVideo').src;
        a.download = 'forbidden-ai-' + Date.now() + '.mp4';
        a.click();
    }

    // FAVORITES
    function toggleFavorite() {
        var id = window._currentGalleryId;
        if (!id) { showToast('Generate an image first', 'error'); return; }
        var newSaved = !window._currentImageSaved;
        fetch('/api/ai/save-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, saved: newSaved })
        }).then(safeJSON).then(function(data) {
            if (data.success) {
                window._currentImageSaved = newSaved;
                document.getElementById('favBtn').textContent = newSaved ? '‚≠ê Favorited!' : '‚≠ê Favorite';
                document.getElementById('favBtn').style.background = newSaved ? 'linear-gradient(135deg, rgba(200,164,94,0.3), var(--bg-card))' : '';
                showToast(newSaved ? 'Added to favorites!' : 'Removed from favorites', 'success');
            }
        });
    }

    // GALLERY
    var _galleryFilter = 'all';
    function loadGallery(filter) {
        filter = filter || _galleryFilter;
        _galleryFilter = filter;
        // Update tab buttons
        document.getElementById('galAllBtn').className = filter === 'all' ? 'btn btn-primary btn-sm' : 'btn btn-sm';
        document.getElementById('galSavedBtn').className = filter === 'saved' ? 'btn btn-primary btn-sm' : 'btn btn-sm';
        
        var url = '/api/ai/gallery' + (filter === 'saved' ? '?saved=true' : '');
        fetch(url).then(safeJSON).then(function(data) {
            var grid = document.getElementById('galleryGrid');
            if (!data.items || data.items.length === 0) {
                var msg = filter === 'saved' 
                    ? '<p style="font-size:0.96rem;">No favorites yet</p><p style="font-size:0.94rem;margin-top:4px;">‚≠ê Favorite your best images to save them here</p>'
                    : '<p style="font-size:0.96rem;">No generated content yet</p><p style="font-size:0.94rem;margin-top:4px;">Generate images or videos to build your library</p>';
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted);">'+msg+'</div>';
                return;
            }
            grid.innerHTML = data.items.map(function(item) {
                var shortPrompt = (item.prompt || '').substring(0, 30) + (item.prompt && item.prompt.length > 30 ? '...' : '');
                var savedStar = item.saved ? '<span style="position:absolute;top:6px;right:6px;font-size:1.1rem;text-shadow:0 1px 3px rgba(0,0,0,0.8);">‚≠ê</span>' : '';
                var bottleTag = item.bottle_type ? '<span style="position:absolute;top:6px;left:6px;font-size:0.7rem;background:rgba(0,0,0,0.6);color:var(--gold);padding:2px 6px;border-radius:4px;">'+(item.bottle_type === 'single_barrel' ? 'SGL' : 'SB')+'</span>' : '';
                if (item.type === 'video') {
                    return '<div style="position:relative;border-radius:var(--radius-md);overflow:hidden;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;" onclick="window.open(\''+item.url+'\')"><video src="'+item.url+'" style="width:100%;height:180px;object-fit:cover;" muted></video>'+savedStar+'<div style="padding:6px 8px;font-size:0.8rem;color:var(--text-muted);">üé¨ '+shortPrompt+'</div></div>';
                }
                var saveBtn = item.id ? '<button onclick="event.stopPropagation();galToggleSave('+item.id+','+(!item.saved)+',this)" style="position:absolute;bottom:32px;right:6px;background:rgba(0,0,0,0.6);border:none;color:white;font-size:0.9rem;padding:3px 6px;border-radius:4px;cursor:pointer;">'+(item.saved ? '‚≠ê' : '‚òÜ')+'</button>' : '';
                return '<div style="position:relative;border-radius:var(--radius-md);overflow:hidden;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;" onclick="window.open(\''+item.url+'\')"><img src="'+item.url+'" loading="lazy" style="width:100%;height:180px;object-fit:cover;">'+savedStar+bottleTag+saveBtn+'<div style="padding:6px 8px;font-size:0.8rem;color:var(--text-muted);">üé® '+shortPrompt+'</div></div>';
            }).join('');
        });
    }

    function galToggleSave(id, saved, btn) {
        fetch('/api/ai/save-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, saved: saved })
        }).then(safeJSON).then(function(data) {
            if (data.success) {
                showToast(saved ? 'Added to favorites!' : 'Removed from favorites', 'success');
                loadGallery();  // Refresh
            }
        });
    }

    // API KEYS
    function saveKey(provider) {
        var key = provider === 'openai'
            ? document.getElementById('openaiKey').value.trim()
            : document.getElementById('runwayKey').value.trim();
        if (!key) { showToast('Enter a key first', 'error'); return; }
        fetch('/api/ai/save-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider: provider, key: key })
        }).then(safeJSON).then(function(data) {
            if (data.success) {
                showToast(provider + ' key saved!', 'success');
                checkApiKeys();
                document.getElementById(provider === 'openai' ? 'openaiKey' : 'runwayKey').value = '';
            } else {
                showToast(data.error || 'Failed', 'error');
            }
        });
    }
</script>

<!-- ===== CUTOUT CACHE CONTROL (injected by patch_aistudio.py) ===== -->
<div id="cutoutCacheControl" style="
    position: fixed;
    bottom: 18px;
    right: 18px;
    z-index: 9999;
    background: rgba(10,10,20,0.92);
    border: 1px solid #ff6b35;
    border-radius: 8px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.5);
">
  <button id="clearCutoutBtn" onclick="clearCutoutCache()"
          style="background:#ff6b35;border:none;color:#fff;padding:7px 14px;
                 border-radius:5px;cursor:pointer;font-size:12px;font-weight:600;
                 letter-spacing:0.5px;white-space:nowrap;">
    Clear Cutout Cache
  </button>
  <span id="clearCutoutMsg" style="font-size:11px;color:#aaa;max-width:240px;"></span>
</div>
<script>
function clearCutoutCache() {
  const btn = document.getElementById('clearCutoutBtn');
  const msg = document.getElementById('clearCutoutMsg');
  btn.disabled = true;
  btn.textContent = 'Clearing...';
  msg.style.color = '#aaa';
  msg.textContent = '';
  fetch('/api/ai/clear-cutout-cache', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        msg.style.color = '#4caf50';
        msg.textContent = data.count > 0
          ? 'Cleared ' + data.count + ' cutout(s). Next gen will re-extract via OpenAI API.'
          : 'Cache was already empty.';
      } else {
        msg.style.color = '#f44336';
        msg.textContent = 'Error: ' + data.error;
      }
      btn.textContent = 'Clear Cutout Cache';
      btn.disabled = false;
    })
    .catch(e => {
      msg.style.color = '#f44336';
      msg.textContent = 'Request failed.';
      btn.textContent = 'Clear Cutout Cache';
      btn.disabled = false;
    });
}
</script>
<!-- ===== END CUTOUT CACHE CONTROL ===== -->
{% endblock %}
